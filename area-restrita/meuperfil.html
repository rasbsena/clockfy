<script>
        // ========================================
        // FUNÃ‡ÃƒO SHERLOCK: PROCURA DADOS EM TODO LUGAR
        // ========================================
        function findCompanyData() {
            let candidates = [];

            // 1. Tenta pegar direto da chave 'empresa_nome'
            const direto = localStorage.getItem('empresa_nome');
            if (direto && direto !== 'undefined') return direto;

            // 2. Analisa o objeto 'empresa' (o mais provÃ¡vel)
            try {
                const empObj = JSON.parse(localStorage.getItem('empresa'));
                if (empObj) {
                    // Tenta todas as variaÃ§Ãµes comuns de nomes de campo
                    if (empObj.nome) return empObj.nome;
                    if (empObj.nome_fantasia) return empObj.nome_fantasia;
                    if (empObj.nomeFantasia) return empObj.nomeFantasia;
                    if (empObj.razao_social) return empObj.razao_social;
                    if (empObj.razaoSocial) return empObj.razaoSocial;
                    if (empObj.company_name) return empObj.company_name;
                    if (empObj.name) return empObj.name; // Se for em inglÃªs
                }
            } catch (e) {}

            // 3. Analisa se estÃ¡ dentro do objeto 'usuario' (Ã s vezes acontece)
            try {
                const userObj = JSON.parse(localStorage.getItem('usuario'));
                if (userObj) {
                    if (userObj.empresa_nome) return userObj.empresa_nome;
                    if (userObj.nome_empresa) return userObj.nome_empresa;
                    
                    // Se 'empresa' for apenas uma string dentro de usuario (ex: "Minha Loja")
                    if (typeof userObj.empresa === 'string') return userObj.empresa;
                    
                    // Se 'empresa' for um objeto dentro de usuario
                    if (typeof userObj.empresa === 'object' && userObj.empresa.nome) return userObj.empresa.nome;
                }
            } catch (e) {}

            // 4. Analisa o payload bruto do login (Ãºltimo recurso)
            try {
                const payload = JSON.parse(localStorage.getItem('login_payload'));
                if (payload) {
                    // Tenta achar em estruturas aninhadas comuns do n8n
                    if (payload.empresa && payload.empresa.nome) return payload.empresa.nome;
                    if (payload.body && payload.body.empresa && payload.body.empresa.nome) return payload.body.empresa.nome;
                }
            } catch(e) {}

            return 'Empresa nÃ£o identificada';
        }

        function getSafeUserField(field1, field2) {
            // Tenta 'usuario_nome'
            let val = localStorage.getItem('usuario_' + field1);
            if (val) return val;

            // Tenta dentro do objeto usuario
            try {
                const userObj = JSON.parse(localStorage.getItem('usuario'));
                if (userObj) {
                    return userObj[field1] || userObj[field2];
                }
            } catch (e) {}
            return null;
        }

        // ========================================
        // INICIALIZAÃ‡ÃƒO
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            
            // LOG DE DIAGNÃ“STICO (Abra o console com F12 para ver isso)
            console.group("ðŸ” DIAGNÃ“STICO CLOCKFY");
            console.log("Raw Empresa:", localStorage.getItem('empresa'));
            console.log("Raw Usuario:", localStorage.getItem('usuario'));
            console.groupEnd();

            // 1. NOME
            let nome = getSafeUserField('nome', 'name') || 'Colaborador';

            // 2. EMAIL
            let email = getSafeUserField('email', 'mail') || 'NÃ£o informado';

            // 3. EMPRESA (Usando a busca inteligente)
            let empresa = findCompanyData();

            // 4. ID
            let id = localStorage.getItem('id_funcionario');
            if (!id) id = getSafeUserField('id', 'id_funcionario') || '---';

            // 5. CARGO
            let cargo = getSafeUserField('cargo', 'role') || 'Colaborador';

            // 6. FOTO
            let foto = getSafeUserField('foto_perfil', 'foto');
            if (!foto) foto = getSafeUserField('avatar', 'image');

            // ===== ATUALIZA A TELA =====
            document.getElementById('displayName').textContent = nome;
            document.getElementById('displayRole').textContent = cargo;
            document.getElementById('displayEmail').value = email;
            document.getElementById('displayCompany').value = empresa;
            document.getElementById('displayId').value = `#${id}`;

            // Foto
            if (foto && foto.length > 10) { 
                const imgElement = document.getElementById('userPhoto');
                const iconElement = document.getElementById('defaultAvatar');
                imgElement.src = foto;
                imgElement.style.display = 'block';
                iconElement.style.display = 'none';
            }
        });

        function goBack() {
            window.location.href = 'clockfyregistro.html'; 
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.clear();
                window.location.href = "../index.html";
            }
        }
    </script>
