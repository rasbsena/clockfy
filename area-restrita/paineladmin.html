<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clockfy - Painel Admin</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23270949' d='M50,5L25,35h50L50,5z'/%3E%3Ccircle fill='%23f93d00' cx='50' cy='60' r='35'/%3E%3Ccircle fill='%23270949' cx='50' cy='60' r='28'/%3E%3Ccircle fill='%23fff' cx='50' cy='60' r='23'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --roxo-escuro: #270949;
      --roxo-medio: #87148C;
      --roxo-vivo: #4F1295;
      --laranja: #F93D00;
      --laranja-esc: #e03800;
      --branco: #fff;
      --vidro: rgba(39, 9, 73, 0.6);
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #270949 0%, #1a0430 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--vidro);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(249, 61, 0, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 50px;
      height: 50px;
    }

    .header-title {
      font-size: 28px;
      font-weight: 800;
    }

    .header-title span {
      color: var(--laranja);
    }

    .admin-badge {
      background: var(--laranja);
      color: #fff;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
    }

    .btn-primary {
      background: var(--laranja);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--laranja-esc);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(249, 61, 0, 0.4);
    }

    .btn-ghost {
      background: transparent;
      color: #fff;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.4);
    }

    /* MAIN GRID */
    .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
    }

    .card {
      background: var(--vidro);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(249, 61, 0, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-subtitle {
      color: #a8a8a8;
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* BUSCA */
    .search-section {
      margin-bottom: 20px;
    }

    .search-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #e0e0e0;
    }

    .search-input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      background: rgba(20, 5, 35, 0.8);
      color: #fff;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--laranja);
      background: rgba(20, 5, 35, 0.95);
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    /* SUGEST√ïES */
    .suggestions {
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .suggestions.show {
      display: block;
    }

    .suggestion-item {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .suggestion-item:hover {
      background: rgba(249, 61, 0, 0.1);
      border-color: rgba(249, 61, 0, 0.3);
      transform: translateX(5px);
    }

    .suggestion-name {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .suggestion-info {
      font-size: 12px;
      color: #a8a8a8;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #a8a8a8;
      font-size: 14px;
    }

    /* FUNCION√ÅRIO SELECIONADO */
    .selected-employee {
      display: none;
      padding: 20px;
      background: rgba(249, 61, 0, 0.1);
      border: 2px solid rgba(249, 61, 0, 0.3);
      border-radius: 16px;
      margin-top: 20px;
    }

    .selected-employee.show {
      display: block;
    }

    .selected-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .selected-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--laranja);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .selected-name {
      font-size: 20px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 4px;
    }

    .selected-id {
      font-size: 13px;
      color: #a8a8a8;
    }

    .btn-clear {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-clear:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .selected-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detail-item {
      font-size: 13px;
    }

    .detail-label {
      color: #a8a8a8;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .detail-value {
      color: #fff;
      font-weight: 500;
    }

    /* MENU DE A√á√ïES */
    .actions-menu {
      display: none;
    }

    .actions-menu.show {
      display: block;
    }

    .action-btn {
      width: 100%;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Montserrat', sans-serif;
    }

    .action-btn:hover {
      background: rgba(249, 61, 0, 0.1);
      border-color: rgba(249, 61, 0, 0.3);
      transform: translateX(5px);
    }

    .action-icon {
      font-size: 20px;
    }

    /* √ÅREA DE FORMUL√ÅRIOS */
    .form-area {
      display: none;
    }

    .form-area.show {
      display: block;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid rgba(249, 61, 0, 0.2);
    }

    .form-title {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #e0e0e0;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      background: rgba(20, 5, 35, 0.8);
      color: #fff;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--laranja);
      background: rgba(20, 5, 35, 0.95);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message {
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 16px;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #86efac;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #fca5a5;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a8a8a8;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 14px;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <script>
    const role = localStorage.getItem('role');
    const usuarioJson = localStorage.getItem('usuario');
    let isAdmin = false;

    if (role === 'Admin') {
      isAdmin = true;
    } else if (usuarioJson) {
      try {
        const usuario = JSON.parse(usuarioJson);
        if (usuario.nivel_acesso === 'Admin' || usuario.role === 'Admin') {
          isAdmin = true;
        }
      } catch (e) {}
    }

    if (!isAdmin) {
      alert('Acesso negado! Apenas administradores podem acessar esta √°rea.');
      window.location.href = 'painel.html';
    }
  </script>

  <div class="container">
    <header class="header">
      <div class="header-left">
        <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <path fill="#270949" d="M50,5L25,35h50L50,5z"/>
          <circle fill="#f93d00" cx="50" cy="60" r="35"/>
          <circle fill="#270949" cx="50" cy="60" r="28"/>
          <circle fill="#fff" cx="50" cy="60" r="23"/>
        </svg>
        <div>
          <div class="header-title">Clock<span>fy</span></div>
          <div class="admin-badge">‚öôÔ∏è Admin</div>
        </div>
      </div>
      <div>
        <button class="btn btn-ghost" onclick="window.location.href='painel.html'" style="margin-right: 10px;">
          ‚Üê Voltar ao Painel
        </button>
        <button class="btn btn-primary" onclick="logout()">Sair</button>
      </div>
    </header>

    <div class="main-grid">
      <aside>
        <div class="card">
          <h2 class="card-title">üîç Buscar Funcion√°rio</h2>
          <p class="card-subtitle">Digite nome ou ID para localizar</p>

          <div class="search-section">
            <label class="search-label">Buscar por Nome</label>
            <input type="text" class="search-input" id="searchName" placeholder="Digite pelo menos 3 caracteres...">
            <div class="suggestions" id="suggestionsName"></div>
          </div>

          <div class="search-section">
            <label class="search-label">Buscar por ID</label>
            <input type="text" class="search-input" id="searchId" placeholder="Digite o ID do funcion√°rio...">
            <div class="suggestions" id="suggestionsId"></div>
          </div>

          <div class="selected-employee" id="selectedEmployee">
            <div class="selected-header">
              <div>
                <div class="selected-title">‚úì Funcion√°rio Selecionado</div>
                <div class="selected-name" id="selectedName">-</div>
                <div class="selected-id">ID: <span id="selectedId">-</span></div>
              </div>
              <button class="btn-clear" onclick="clearSelection()">‚úï Limpar</button>
            </div>
            <div class="selected-details">
              <div class="detail-item">
                <div class="detail-label">E-mail</div>
                <div class="detail-value" id="selectedEmail">-</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">WhatsApp</div>
                <div class="detail-value" id="selectedWhatsApp">-</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Cargo</div>
                <div class="detail-value" id="selectedRole">-</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Carga Hor√°ria</div>
                <div class="detail-value" id="selectedCarga">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card actions-menu" id="actionsMenu" style="margin-top: 20px;">
          <h3 class="card-title">‚ö° A√ß√µes Dispon√≠veis</h3>
          <p class="card-subtitle">Escolha uma a√ß√£o para executar</p>

          <button class="action-btn" onclick="openForm('corrigir')">
            <span class="action-icon">‚úèÔ∏è</span>
            <span>Corrigir Ponto</span>
          </button>
          <button class="action-btn" onclick="openForm('lancar')">
            <span class="action-icon">üìù</span>
            <span>Lan√ßar Ponto Antigo</span>
          </button>
          <button class="action-btn" onclick="openForm('espelho')">
            <span class="action-icon">üìÑ</span>
            <span>Receber Espelho de Ponto</span>
          </button>
          <button class="action-btn" onclick="openForm('atualizar')">
            <span class="action-icon">üë§</span>
            <span>Atualizar Dados</span>
          </button>
          <button class="action-btn" onclick="openForm('promover')">
            <span class="action-icon">‚≠ê</span>
            <span>Promover para Admin</span>
          </button>
          <button class="action-btn" onclick="openForm('excluir')">
            <span class="action-icon">üóëÔ∏è</span>
            <span>Excluir Funcion√°rio</span>
          </button>
        </div>
      </aside>

      <main>
        <div class="card empty-state" id="emptyState">
          <div class="empty-state-icon">üëà</div>
          <div class="empty-state-text">Selecione um funcion√°rio</div>
          <div class="empty-state-subtext">Use a busca ao lado para localizar e selecionar um funcion√°rio</div>
        </div>

        <!-- Formul√°rios omitidos por brevidade - continuam iguais ao original -->
      </main>
    </div>
  </div>

  <script>
    const WEBHOOK_SEARCH = 'https://n8n.upperfy.com.br/webhook/b9750986-24a2-46f5-820f-clockadminsearch';
    
    let selectedEmployee = null;
    let searchTimeout = null;

    const searchName = document.getElementById('searchName');
    const searchId = document.getElementById('searchId');
    const suggestionsName = document.getElementById('suggestionsName');
    const suggestionsId = document.getElementById('suggestionsId');
    const selectedEmployeeDiv = document.getElementById('selectedEmployee');
    const actionsMenu = document.getElementById('actionsMenu');
    const emptyState = document.getElementById('emptyState');

    searchName.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (query.length >= 3) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchEmployees('nome', query, suggestionsName);
        }, 300);
      } else {
        suggestionsName.classList.remove('show');
        suggestionsName.innerHTML = '';
      }
    });

    searchId.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (query.length >= 1) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchEmployees('id', query, suggestionsId);
        }, 300);
      } else {
        suggestionsId.classList.remove('show');
        suggestionsId.innerHTML = '';
      }
    });

    async function searchEmployees(type, query, suggestionsElement) {
      suggestionsElement.innerHTML = '<div class="no-results">üîç Buscando...</div>';
      suggestionsElement.classList.add('show');

      try {
        const localStorageData = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          localStorageData[key] = localStorage.getItem(key);
        }

        const payload = {
          ...localStorageData,
          tipo_busca: type,
          busca: query
        };

        const response = await fetch(WEBHOOK_SEARCH, {
          method: 'POST',
          mode: 'cors',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        const textResponse = await response.text();
        const data = JSON.parse(textResponse);

        // üîß CORRE√á√ÉO: Converte objeto √∫nico em array
        let employees;
        if (Array.isArray(data)) {
          employees = data;
        } else if (data && typeof data === 'object') {
          employees = [data];
        } else {
          employees = [];
        }

        displaySuggestions(employees, suggestionsElement);

      } catch (error) {
        suggestionsElement.innerHTML = `<div class="no-results">‚ùå Erro ao buscar funcion√°rio</div>`;
      }
    }

    function displaySuggestions(employees, suggestionsElement) {
      if (!employees || !Array.isArray(employees) || employees.length === 0) {
        suggestionsElement.innerHTML = '<div class="no-results">üòï Nenhum funcion√°rio encontrado</div>';
        return;
      }

      const html = employees.map((emp) => {
        const empJson = JSON.stringify(emp).replace(/'/g, "\\'");
        return `
          <div class="suggestion-item" onclick='selectEmployee(${empJson})'>
            <div class="suggestion-name">${emp.nome_completo || emp.nome || 'Sem nome'}</div>
            <div class="suggestion-info">
              ID: ${emp.id || emp.id_funcionario || 'N/A'} ‚Ä¢ 
              ${emp.email || 'Sem email'} ‚Ä¢ 
              ${emp.role || emp.nivel_acesso || 'Funcion√°rio'}
            </div>
          </div>
        `;
      }).join('');

      suggestionsElement.innerHTML = html;
    }

    function selectEmployee(employee) {
      selectedEmployee = employee;
      
      document.getElementById('selectedName').textContent = employee.nome_completo || employee.nome;
      document.getElementById('selectedId').textContent = employee.id || employee.id_funcionario;
      document.getElementById('selectedEmail').textContent = employee.email || '-';
      document.getElementById('selectedWhatsApp').textContent = employee.numero_whatsapp || employee.whatsapp || '-';
      document.getElementById('selectedRole').textContent = employee.role || employee.nivel_acesso || 'Funcion√°rio';
      document.getElementById('selectedCarga').textContent = (employee.carga_horaria_diaria || employee.carga_horaria || '0') + 'h';
      
      selectedEmployeeDiv.classList.add('show');
      actionsMenu.classList.add('show');
      emptyState.style.display = 'none';
      
      suggestionsName.classList.remove('show');
      suggestionsId.classList.remove('show');
      suggestionsName.innerHTML = '';
      suggestionsId.innerHTML = '';
      
      searchName.value = '';
      searchId.value = '';
    }

    function clearSelection() {
      selectedEmployee = null;
      selectedEmployeeDiv.classList.remove('show');
      actionsMenu.classList.remove('show');
      emptyState.style.display = 'block';
    }

    function logout() {
      if (confirm('Deseja realmente sair?')) {
        localStorage.clear();
        window.location.href = '../index.html';
      }
    }
  </script>
</body>
</html>
