<!-- ...código anterior inalterado... -->

<script>
  // ========== CONFIGURAÇÃO ==========
  const N8N_WEBHOOK_URL = 'https://n8n.upperfy.com.br/webhook/18c1a3aa-f03a-4823-98b1-painelclockfy';
  const N8N_ESPELHO_URL = 'https://n8n.upperfy.com.br/webhook/espelho-ponto';
  // ...demais constantes e variáveis...

  // ========== SUBMISSÃO DO FORMULÁRIO (para gerar espelho de ponto) ==========
  reportForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;

    if (!month || !year) {
      showMessage('Por favor, selecione o mês e o ano.', 'error');
      return;
    }

    setLoading(true);
    message.style.display = 'none';

    try {
      // Coletar todos os dados do localStorage
      const localStorageData = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        localStorageData[key] = localStorage.getItem(key);
      }

      // Enviar localStorage + dados do formulário para N8N (geração do espelho)
      const response = await fetch(N8N_ESPELHO_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          ...localStorageData,
          mes: month,
          ano: year 
        })
      });

      if (!response.ok) {
        throw new Error('Erro ao gerar relatório');
      }

      const data = await response.json();
      
      // Tratamento da resposta do N8N (sucesso ou falha)
      if (data.status === 'success') {
        // Sucesso: baixar PDF automaticamente
        if (data.pdfBase64) {
          downloadPDF(data.pdfBase64, `espelho-ponto-${year}-${month}.pdf`);
        }
        // Sucesso: exibir mensagem de sucesso com link para download manual
        message.innerHTML = (data.mensagem || 'Espelho de ponto gerado com sucesso!') +
          '<br><a href="' + data.urlEspelho + '" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: underline;">Seu download teve algum erro ou está demorando demais? Clique aqui</a>.' +
          '<br><small>Este link é temporário.</small>';
        message.className = 'message success';
        message.style.display = 'block';
      } else {
        // Falha: exibir mensagem de erro retornada
        const errorMsg = data.mensagem || 'Não foi possível gerar o espelho de ponto. Tente novamente em alguns minutos.';
        showMessage(errorMsg, 'error');
      }

    } catch (error) {
      console.error('Erro:', error);
      showMessage('Erro ao gerar relatório. Tente novamente.', 'error');
    } finally {
      setLoading(false);
    }
  });

  // ========== EXECUTAR INICIALIZAÇÃO ==========
  initializePage();
</script>

<!-- ...código posterior inalterado... -->
